# 初步学习


- 目录
    - [能做什么](#能做什么)
        - [静态 HTTP 服务器](#静态-HTTP-服务器)
        - [反向代理](#反向代理)
        - [负载均衡](#负载均衡)
        - [虚拟主机](#虚拟主机)
    
### 能做什么

Nginx 是一款 Web 服务器，但它提供的功能并不仅仅是作为一个容器。

#### 静态 HTTP 服务器

首先，Nginx 是一个静态 HTTP 服务器，可以将服务器上的静态文件（如 HTML、图片）通过 HTTP 协议展现给客户端。

配置：

```C
location / {
    # 静态文件路径
    root   D:/Developer/Projects/Demo_Nginx/static;
    index  index.html;
}
```

#### 反向代理

代理涉及到两个角色：一个是被代理角色，一个是目标角色。被代理角色通过代理访问目标角色完成一些任务的过程即代理操作过程。

- 正向代理

正向代理服务器是一个位于客户端和原始服务器 (origin server) 之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标 (原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。

正向代理一般需要在客户端加以配置，客户端是知道目标服务器地址的，代理服务器代理的是客户端。

正向代理很容易理解，如我们（被代理角色）访问 Google（目标角色） 需要借助 VPN（代理）实现，这就是一个典型的正向代理。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/redis/正向代理示意图.png" width="600px">
</div>

- 反向代理

反向代理

反向代理是指以代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。

反向代理和正常代理最大的不同，代理服务器代理的是服务端。客户端访问的地址是代理服务器，代理服务器将请求反向代理到真实服务器，而这些客户端是不知道的。

像我们访问 Baidu 时，代理服务器会将请求代理到内网服务器，这一方面方便扩展服务器规模，另一方面保证了服务器的安全性。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/redis/反向代理示意图.png" width="600px">
</div>

配置：

```C
location / {
    # 应用服务器HTTP地址
    proxy_pass http://192.168.83.22:8080; 
}
```

为了加快服务器的解析速度，还可以借助 Nginx 把动态页面和静态页面代理给不同的服务器来解析，加快解析速度，降低原来单个服务器的压力。

#### 负载均衡

反向代理可以伸缩服务器规模，顺其自然地产生了负载均衡，将请求压力分担到多台服务器上。

Nginx 可以通过 upstream 定义服务列表，并将请求转发到配置的服务中。

配置：

```C
upstream serverturn {  
    server 127.0.0.1:9091 weight=1;  
    server 127.0.0.1:9092 weight=2;
    server 127.0.0.1:9093 weight=3;  
    server 127.0.0.1:9094 weight=4;  
    server 127.0.0.1:9095 weight=5;
} 

location /test  {
    proxy_pass   http://serverturn/test;
}
```

Nginx 支持多种负载均衡调度算法：

- `RR 轮询`:每个请求按时间顺序逐一分配到不同的后端服务器，即使在使用过程中，某一台后端服务器宕机，Nginx 会自动将该服务器剔除出队列，请求受理情况不会受到任何影响。
- `加权轮询`:在 RR 基础上增加了权重，权重越大的服务器被分配到的几率越大。
- `ip_hash`:每个请求按照发起客户端的 ip 的 hash 结果进行匹配，这样的算法下一个固定 ip 地址的客户端总会访问到同一个后端服务器，这也在一定程度上解决了集群部署环境下 Session 共享的问题。
- `fair`:fair 是第三方负载均衡算法，需要引入 fair 模块。fair 根据后端服务器的请求处理到响应的时间动态地进行均衡分配，响应时间短处理效率高的服务器分配到请求的概率高，响应时间长处理效率低的服务器分配到的请求少。
- `url_hash`:url_hash 是第三方负载均衡算法，需要引入 hash 模块。url_hash 按照访问的 url 来分配请求，让相同的 url 定向到同一个服务器，多用于缓存服务器。
- `least_conn`:最少连接数，分配到链接数少地服务器上。
- `consistent_hash`:采用一致性 hash 算法进行负载均衡。

#### 虚拟主机 

往往一个机器我们可能会部署多个服务器，这回导致多个域名 DNS 解析指向这个 IP。Nginx 可以配置通过 server，将不同域名下的请求代理到运行在不同端口的服务上，
两个服务互不干扰，故称虚拟主机。

配置：

```C
server {
    listen      80;
    server_name www.aaa.com; # www.aaa.com 域名
    location / {
    proxy_pass http://localhost:8080; # 对应端口号 8080
    }
}
server {
    listen      80;
    server_name www.bbb.com; # www.bbb.com 域名
    location / {
    proxy_pass http://localhost:8081; # 对应端口号 8081
    }
}
```