# 执行流程

一条 SQL 究竟是如何执行的，这是我们需要了解的。

### 体系结构 

总体上，我们可以把 MySQL 数据库分成三层，跟客户端对接的是连接层，真正执行操作的是服务（Server）层，和跟硬件打交道的存储引擎层。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/mysql/体系结构.png" width="600px">
</div>

客户端要连接到 MySQL 服务器 3306 端口（默认端口），必须要跟服务端建立连接，管理所有的连接，验证客户端的身份和权限，这些功能就在连接层完成。

连接层会把 SQL 语句交给服务层，这里面又包含一系列的流程，包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

存储引擎就是我们的数据真正存放的地方，MySQL 数据库支持插件式存储引擎，直接与内存、磁盘交互。

#### 连接器

第一步，客户端会先连接到 MySQL 服务器上，连接器就是负责跟客户端建立连接、获取权限、维持和管理连接的模块。连接命令如下：

```sql
mysql -h $ip -P $port -u $user -p
```

在完成经典的 TCP 握手后，连接器就要开始身份认证，如果用户名或密码不对，客户端就会收到一个 "Access denied for user" 的错误，然后客户端程序结束执行。

如果用户名密码认证通过，连接器会到权限表里面查出用户名拥有的权限。之后，这个连接执行命令的权限判断逻辑都将依赖于此时读到的权限。这就意味着，一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。

#### 查询缓存

MySQL 内部自带了一个缓存模块，把数据以键值对的形式放到内存里面，加快数据读取，缩短服务器处理时间。但是这个功能很鸡肋：一方面它要求 SQL 语句必须一模一样，大小写、空格都不允许有出入；另一方面表里面任何一条数据发生变化，这张表所有缓存都会失效。

在 MySQL 8.0 中，查询缓存已被移除。

#### 分析器

如果查询缓存没有开启或没有命中，下面就要为执行语句做准备了。首先 MySQL 服务器需要分析语句：分为词法分析和语法分析。

分析器先会进行词法分析。它会识别出语句中每个字符串分别代表什么，如分析出关键字、列名、表名等。

完成词法分析，就要进行语法分析。语法分析会对 SQL 语句做一些语法检查，比如单引号有没有闭合，然后根据 MySQL 定义的语法规则，生成一个语法解析树。

分析器中还包含一个预处理器，它会检查生成的语法解析树，解决解析器无法解析的语义。比如，它会检查表和列名是否存在，检查名字和别名，保证没有歧义。预处理之后会得到一个新的语法解析树。

#### 优化器

得到解析树之后，并不会直接执行 SQL 语句，还会经过优化器的处理。

优化器的目的就是根据语法解析树生成不同的执行计划（Execution Plan），然后选择一种最优的执行计划，MySQL 里面使用的是基于开销（cost）的优化器，执行开销最小的执行计划。

优化器能处理的优化类型：
- 当我们对多张表进行关联查询的时候，以哪个表的数据作为基准表。
- 有多个索引可以使用的时候，选择哪个索引。
- ...

####  执行器

MySQL 通过分析器知道了做什么，通过优化器知道了怎么做，下面就进入了执行阶段。

开始执行的时候，会先判断一下该连接对这个表有没有对应权限，如果没有，就会返回没有权限的错误，如果有权限，就打开表继续执行。这时候就要涉及一个问题，数据是如何存储的。MySQL 采用的是插件式存储引擎，执行器对表的操作都是通过存储引擎提供的接口实现的，并负责接收并返回执行引擎接口的返回值。