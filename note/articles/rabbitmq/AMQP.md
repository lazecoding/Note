# AMQP

- 目录
    - [工作模型](#工作模型)
    - [消息](#消息)
    - [队列](#队列)
    - [绑定](#绑定)
    - [交换机](#交换机)
      - [直连交换机](#直连交换机)
      - [扇型交换机](#扇型交换机)
      - [主题交换机](#主题交换机)
      - [头交换机](#头交换机)
    - [消费者](#消费者)
      - [消息确认](#消息确认)
      - [拒绝消息](#拒绝消息)
    - [连接](#连接)
    - [通道](#通道)
    - [消息代理](#消息代理)
    - [虚拟主机](#虚拟主机)
    - [持久化](#持久化)
    - [AMQP 的应用](#AMQP-的应用)

> 高级消息队列协议即 Advanced Message Queuing Protocol（AMQP）是面向消息中间件提供的开放的应用层协议，其设计目标是对于消息的排序、路由（包括点对点和订阅-发布）、保持可靠性、保证安全性。
> AMQP 规范了消息传递方和接收方的行为，以使消息在不同的提供商之间实现互操作性，就像 SMTP，HTTP，FTP 等协议可以创建交互系统一样。与先前的中间件标准（如 Java 消息服务）不同的是，
> JMS 在特定的 API 接口层面和实现行为上进行了统一，而高级消息队列协议则关注于各种消息如何以字节流的形式进行传递。因此，使用了符合协议实现的任意应用程序之间可以保持对消息的创建、传递。
> 
> 维基百科

AMQP（高级消息队列协议）是一个网络协议。它支持符合要求的客户端应用（application）和消息中间件代理（messaging middleware broker）之间进行通信。消息代理（message brokers）从生产者（producers）那儿接收消息，并根据既定的路由规则把接收到的消息发送给处理消息的消费者（consumers）。由于 AMQP 是一个网络协议，所以这个过程中的发布者、消费者、消息代理可以存在于不同的设备上。

### 工作模型

消息（message）被发布者（publisher）发送给交换机（exchange），交换机会将接收到的消息根据路由规则（routing）分发给绑定（binding）的队列（queue），最后由消息代理（message brokers）将消息投递给订阅了该队列的消费者（consumer），或者消费者按照需求自行获取。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/rabbitmq/AMQP工作模型.png" width="600px">
</div>

### 消息

消息（message）由消息头和消息体组成，是消息投递的实体，存储在队列中。

### 队列

队列（queue）中存储着等待消费的消息。

### 绑定

绑定（binding）是交换机将消息路由给某队列所遵循的规则。如果指定交换机 E 将消息路由给队列 Q，就需要声明一个可选的路由键（routing key）将队列 Q 和交换机 E 建立绑定，交换机根据路由键将接收到的消息路由到绑定的队列。

### 交换机

交换机是用来传递消息的实体。交换机接收消息后根据路由规则将消息路由给一个或多个队列。它使用哪种路由算法是由交换机类型和绑定规则所决定的。

| 交换机类型                   | 预声明的默认名称                           |
| -------------------------- | -------------------------------------- |
| Direct exchange（直连交换机） | (Empty string) and amq.direct          |
| Fanout exchange（扇型交换机） | amq.fanout                              |
| Topic exchange（主题交换机）  | amq.topic                               |
| Headers exchange（头交换机） | amq.match (and amq.headers in RabbitMQ) |

#### 直连交换机

直连型交换机是根据消息携带的路由键将消息发送到与交换机绑定相同路由键的队列上。

#### 扇型交换机

扇型交换机是一种广播交换机，它会将接收到的消息路由到所有绑定该交换机的队列，与路由规则无关。

#### 主题交换机

主题交换机通过对消息的路由键和队列到交换机的绑定模式之间的匹配，将消息路由给一个或多个队列。主题交换机经常用来实现各种分发/订阅模式及其变种。主题交换机通常用来实现消息的多播路由（multicast routing）。主题交换机和直连交换机的区别在于后者根据明确的路由键路由，主题交换机可以根据规则模糊匹配路由键去路由消息。

#### 头交换机

头部交换机会忽略路由键，它使用头部信息代替路由键建立路由规则，通过判断消息头的值能否与指定的绑定相匹配来确立路由规则。消息可以指定一组或者多组头部信息用于头部交换机匹配消息队列，我们可以使用头来指定满足任意一组还是必须所有满足才能将消息传递给消息队列。由于性能问题，头部交换机并不常用。

### 消费者

消费者（Consumer）可以消费队列中消息，AMQP 规定了两种消费方式：订阅投递和主动获取。

#### 消息确认

网络是不可靠的，Customer 可能因为某种原因导致无法真成功处理消息，AMQP 模型中规定了消息确认机制，当消息被 Customer 接收时，Customer 可以手动或自动通知消息代理确认已接收到消息，而后消息代理才会将消息从消息队列中完全删除。

#### 拒绝消息

消费者对消息的处理可能成功也可能失败，消费者可以通过拒绝消息表示该消息处理失败，同时告知消息代理丢弃或重新请求该条消息。

### 连接

AMQP 是一个使用 TCP 提供可靠投递的应用层协议。AMQP 使用认证机制并且提供 TLS（SSL）保护。当一个应用不再需要连接到 AMQP 代理的时候，会释放掉 AMQP 连接，而不是直接将 TCP 连接关闭。

### 通道
通道（channel）是多路复用连接中的一条独立的双向数据流通道，它是建立在 TCP 连接中的虚拟连接，用于发送 AMQP 命令。多个信道可以共享同一条 TCP 连接，这意味着对请求的应答不会阻塞新的消费请求，而且可以减少建立、消费 TCP 连接的开销。

### 消息代理

消息代理（message brokers）就是一个独立的代理实体，如一个 RabbitMQ 服务器。

### 虚拟主机

虚拟主机（virtual hosts）可以在一个消息代理上实现多个隔离的代理环境，当连接建立时，AMQP 需要指定使用哪一个虚拟主机。

### 持久化

持久性在交换机、队列、消息上都有体现，持久化的主要作用就是将信息写入磁盘，当 RabbtiMQ 服务宕机重启后，从磁盘中读取并恢复数据。队列的持久化能保证本身的元数据不会因服务宕机而丢失，但不能保证队列中的消息不丢失，需要额外开启消息持久化。如果交换机和队列是持久化的，那么他们之间的绑定也是持久化的，如果交换机和队列之间一个持久化，一个非持久化就不允许建立绑定。

### AMQP 的应用

RabbitMQ 是实现了 AMQP 模型的开源消息代理软件，遵循 AMQP 规范建立了多种工作模式。RabbitMQ 服务器是用 Erlang 语言编写的，而聚类和故障转移是构建在开发电信平台框架上的，具有低延迟和健壮的故障恢复的特点，这让 RabbitMQ 保持了较好的性能。





