# 幂等

- 目录
    - [如何保证接口幂等](#如何保证接口幂等)
      - [业务判断](#业务判断)
      - [乐观锁](#乐观锁)
      - [唯一键](#唯一键)
      - [token 机制](#token-机制)

> 幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于抽象代数中。 在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，
> 是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。
>
> 百度百科

幂等是系统设计中十分重要的概念，接口设计时须秉持着一种理念：对同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的。 

重复请求的场景：

- 用户交互的时候多次点击。如：快速点击按钮多次。
- 消息中间件，重复消费。
- 第三方平台的接口，因异常导致多次异步回调。
- 微服务场景下，请求超时会导致微服务框架请求重试。
- 其他中间件/应用服务根据自身的特性，也可能进行重试。

接口幂等的影响因素：

接口是否幂等取决于对资源的操作是否幂等。从增改删查的角度来看，删查操作必然是幂等操作，增操作是非幂等操作，如果改操作是指定值修改则是幂等操作，如果改操作依赖上一次结果则是非幂等操作。

### 如何保证接口幂等

#### 业务判断

业务判断是最简单、最容易想到的方式，通常会配合同步机制（同步锁、分布式锁）来使用，如订单系统，订单付款操作执行时先进行同步，保证只能有一人操作订单，再查询订单状态是否已付款，
根据付款状态进一步处理，业务结束后退出同步。

#### 乐观锁

多版本并发控制，也就是业务执行前先获取当前数据的 version，操作时候带上 version 条件。

```sql
UPDATE table
SET count = count + 1,
    version = version + 1
WHERE id = 2
    AND version = 2
```

#### 唯一键

如果事务中存在非幂等的数据库操作，唯一键为本地事务的幂等性提供了实现基础。使用 `带有唯一键的去重表`，在事务中先执行 insert 去重表，再执行其他业务操作，然后提交事务，
事务过程中出现异常回滚事务，可以保证事务的幂等性。具体流程如图所示：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/systemdesign/幂等-唯一键流程.png" width="400px">
</div>

通常去重表同时也是业务表，对于唯一键此处提供两种设计思路：

- 在请求参数中附带唯一标识作为唯一键，唯一标识可以采用分布式ID，具体内容可以移步：[分布式ID](https://github.com/lazecoding/Note/blob/main/note/articles/systemdesign/DistributedId.md) 。
- 找出业务本身的唯一约束。比如一个用户对一篇文章只能点赞一次，那么用户编号和文章编号就可以组成唯一键。

#### token 机制

服务端提供一个 token 生成接口，客户端调用时返回 token 并存入 Redis，携带 token 业务请求执行时从 Redis 中删除该 token。客户端调用业务接口时携带 token，服务器检查 Redis 中是否存在该 token，
如果存在则执行，不存在则说明该请求执行过，不再执行。

token 删除有两种方案：一是检验 token 存在后立刻删除 token；二是检验 token 存在，先进行业务处理再删除 token。个人建议是检验 token 存在后立刻删除 token，如果业务处理成功，
删除 token 异常会执行重复的业务请求。

token 机制缺点：采用 token 机制，每次业务请求都额外增加一次请求（获取 token）。真实环境中，一般只有极小比例的请求会发生重试，为了这小比例请求，让每次业务请求都增加了额外的请求，优劣有待商榷。


