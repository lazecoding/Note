# 分布式存储系统

- 目录
  - [数据分布](#数据分布)
  - [同步](#同步)
  - [CAP](#CAP)
  - [协议](#协议)
    - [Paxos](#Paxos)
    - [两阶段提交协议](#两阶段提交协议)
    - [三阶段提交协议](#三阶段提交协议)

分布式系统基本可以分为三类：分布式存储系统、分布式计算系统、分布式管理系统。其中，分布式存储系统是一个古老的问题，同时也是分布式系统里最难，最复杂，涉及面最广的问题。 

> 分布式存储系统是将数据分散存储在多台设备上，多台设备分担存储负荷，利用元数据服务器定位存储信息，提高了系统的可靠性、可用性和存取效率，易于扩展，并将这些分散的存储设备构建成一个虚拟的大的存储池来供上层应用来使用。

### 数据分布

分布式存储系统面临的第一个问题就是 `数据分布`，即如何将数据均匀地分布到多个数据分片上。另外为了保证可靠性和可用性，需要将数据复制成多个副本，这就带来了多个副本之间的一致性问题。大规模分布式存储系统存在很多节点（分片 * 副本），每个节点都可能在某个时间发生故障，这要求系统能在软件层次自动容错。

数据分布，一般可以分为两类：`随机分布` 和 `顺序分布`。

- `哈希取模`：改算法根据数据的某种特征值计算哈希，并将哈希值与集群中的节点建立映射关系，从而将不同哈希值的数据分布到不同节点上。如果哈希函数的散列性能很好，哈希方式可以将数据比较均匀地分布到集群中去。但一旦有节点加入或退出，所有的原有节点都会受到影响，稳定性无从谈起。
- `一致性哈希`：该算法的实现原理是将集群中的节点和 key 值都按照一样的哈希算法映射到一个哈希空间大小指定的圆环上。当有一个写请求到来时，计算 Key 值对应的哈希值 Hash(Key)，如果该值正好对应之前某个机器节点的 Hash 值，则直接写入该机器节点，如果没有对应的机器节点，则顺时针查找下一个节点，进行写操作，如果超过哈希空间还没找到对应节点，则从 0 开始查找(因为是环状结构)。一致性哈希的优点在于节点加入和删除时只会影响相邻节点，但是可能出现数据倾斜，如果删除节点需要迁移的数据过大会导致负载不均衡。
- `带虚拟节点的一致性哈希`：传统的一致性哈希存储数据倾斜、负载不均的问题，为此可以引入虚拟节点，即集群中的节点对应多个哈希值，这样可以让节点尽可能均匀分布，避免数据倾斜。
- `顺序分布`：哈希散列破坏了数据的有序性，只支持随机读取，不支持顺序扫描。这时候就需要严格排序的顺序分布，顺序分布的缺点是负载均衡，当存在一批 Key 连续写入，数据只会在一个分片上追加，分布式系统便退化为单节点系统，这样的问题也存在于读操作，顺序分布存在无法发挥分布式系统特性的场景。

随机分布和顺序分布没有优劣之分，只有哪个更适合。

### 同步

为了保证高可用，分布式存储系统中的数据一般存在多个副本，并通过复制协议将数据同步到多个副本，并确保多个副本的数据一致性。最常见的复制协议是基于主副本的复制协议，客户端将写请求发送给主副本，主副本将写请求复制到其他备副本。基于主副本的复制协议的根据其同步策略又可用分为 `强同步复制` 和 `异步复制`。

- 强同步复制：主副本首先将操作日志同步到其他备副本，备副本回放日志（至少存在一个备副本同步成功），完成操作后通知主副本，主副本再修改本地，等到主副本也完成写操作时通知客户端。强同步协议保证了强一致性，但是如果备副本出现故障将阻塞写请求，系统可用性较差。
- 异步复制：异步复制中，主副本不需要等待备副本回应，主要本地写成功即返回客户端写成功。采用异步复制的方式系统可用性较好，但一致性较差，如果主副本发生不可恢复故障，可能丢失最后一小部分数据。

### CAP

分布式系统领域有一个著名的 CAP 理论，简单的说就是 `一致性`、`可用性` 和 `分区可容忍性` 三者不能同时满足。

- `一致性`：读操作总是能读取到之前完成的写操作结果，满足这条件称之为 "强一致性"。
- `可用性`：读写操作在单台机器发送故障的情况下仍然能够正常执行，而不需要等待发生故障机器重启或者其上的服务迁移到其他机器。
- `分区可容忍性`：机器故障、网络故障、机房停电等异常情况下仍然能满足一致性和可用性。

分布式系统要求能够自动容错，所以分区可容忍性是必要条件，因此一致性和写操作的可用性不能同时满足。为了协调分布式系统的一致性和可用性提出了 `BASE理论`，它是 Basically Available(基本可用)、Soft-state（软状态）和 Eventually Consistent（最终一致性）的缩写，为 `最终一致性` 的提供理论支撑。简单理解，在分布式系统中允许损失部分可用性，并且不同节点进行同步存在延时，但经过一段时间的修复能够达到数据的最终一致性。

### 协议

分布式系统涉及很多协议，其中以 Paxos 协议和两阶段提交协议最具代表性。

#### Paxos

Paxos 协议解决的是分布式一致性问题，即一个分布式系统中的各个进程如何就某个值（决议）达成一致。一个或多个提议者 (Proposer) 可以发起提议 (Proposal)，Paxos 算法保证其中的某一个提议在所有进程中达成一致，且最多只针对一个确定的提议达成一致。Paxos 算法采用大多数 (Majority) 机制保证系统拥有 2F+1 的容错能力，即 2F+1 个节点的系统最多允许 F 个节点出现故障。

Paxos 协议的三种角色：Proposer(提议者)、Acceptor(决策者)和 Learner(决策学习者):

- `Proposer`: 提出提议(Proposal)。Proposal 信包括提议编号 (Proposal ID) 和提议值 。
- `Acceptor`：参与决策，回应 Proposer 的提议。收到 Proposal 后可以接受提议，若 Proposal 获得多数 Acceptor 的接受，则称该 Proposal 被批准。
- `Learner`：不参与决策，从 Proposer/Acceptor 学习最新的达成一致的提议值。

每个副本同时具有 Proposer、Acceptor、Learner 三种角色。

Paxos 协议的三个阶段：Prepare 阶段、Accept 阶段、Learn 阶段。

- `Prepare 阶段`：Proposer 首先选择一个提议序号 n 并向其他 Acceptor 节点发送 Prepare 消息。Acceptor 接收 Prepare 消息后，如果提议序号大于他已经回复的所有 Prepare 消息，则 Acceptor 将自己上次接受的提议值回复给 Proposer,并承诺不再回复小于 n 的提议值。
- `Accept 阶段`：Proposer 收到了 Acceptor 中多数派对 Prepare 的回复后，就进人 Accept 阶段。如果在之前的 Prepare 阶段 Acceptor 回复了上次接受的提议值，那么，Proposer 选择其中序号最大的提议值发给 Acceptor 批准。否则，Proposer 生成一个新的提议值给 Acceptor 批准。Acceptor 在不违背他在 Prepare 阶段的承诺的前提下，接受这个请求。
- `Learn 阶段`：Proposer 在收到多数 Acceptor 的 Accept 之后，标志着本次 Accept 成功，Proposer 通知其他 Acceptor 提议值生效。

Paxos 协议需要考虑两个问题:`正确性`，即只有一个提议值生效；`可终止性`，即最后总会有一个提议值生效。Paxos 协议中要求每个生效的提议值被 Acceptor 中多数派接受，并且每个 Acceptor 不会接受两个不同的提议值，因此正确性可以保证。Paxos 协议只要存在一个 Acceptor 接受了提议值，Proposer 就会发现并重新提议其中序号最大的提议值，随着协议不断运行，最终将实现某个提议值被多数派接受并生效，即可终止。

#### 两阶段提交协议

两阶段提交协议的两种角色：`协调者` 和 `参与者`。

- `协调者（事务管理者）`：通常一个系统中只有一个。
- `参与者（资源管理者）`：一般包含多个，在分布式存储系统中可以理解为分片副本。

两阶段提交协议的两个阶段：`准备阶段` 和 `提交阶段`。

- `准备阶段`：协调者向参与者发出准备指令，询问参与者预提交是否成功，参与者执行操作，并不提交，告诉协调者预提交成功还是失败。
- `提交阶段`：如果全部参与者都预提交成功，则协调者正式提交命令。如果其中有任意一个参与者预提交失败，则执行回滚命令。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/systemdesign/两阶段提交协议执行流程图.png" width="600px">
</div>

两阶段提交协议提供了一种强一致性的解决方案，但是存在问题。一是单点问题，协调者宕机会导致整个流程都被阻塞。二是同步阻塞，整个流程是同步操作，参与者故障也会导致整个流程被阻塞。两阶段提交协议是阻塞协议，执行过程需要锁定资源，并不是一个理想方案。

#### 三阶段提交协议

`三阶段提交协议` 是 `两阶段协议` 的改良版本，他与 `两阶段提交协议` 不同之处在于引入超时机制来解决同步阻塞问题，此外加入了预备阶段，尽可能早的发现无法执行的参与者并终至事务，如果全部参与者都可用完成才发起第二阶段的准备和第三阶段的提交。`三阶段提交协议` 解决了同步阻塞问题，但极小概率下可能会出现数据不一致，因为 `三阶段提交提交协议` 引入了超时机制，当参与者出现超时默认提交成功，如果其没有成功执行或者其他参与者出现回滚，就会出现数据不一致。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/systemdesign/三阶段提交协议执行流程图.png" width="600px">
</div>

`Paxos 协议` 和 `两阶段提交协议` 在分布式存储系统中起到了不同的作用，**`Paxos 协议` 用于保证同一数据分片的多个副本之间数据的一致性**，**`两阶段提交协议` 用于保证多个数据分片上操作的原子性**。通常他们把 `Paxos 协议` 和 `两阶段提交协议` 结合使用，并通过 `Paxos 协议` 解决 `两阶段提交协议` 中协调者宕机问题。当 `两阶段提交协议` 中协调者出现故障，通过 `Paxos 协议` 选举出新的协调者继续服务。