# 架构设计

- 目录
    - [设计原则](#设计原则)
    - [基本架构](#基本架构)
    - [整体架构](#整体架构)
      - [用户层](#用户层)
      - [业务层](#业务层)
      - [内核层](#内核层)
      - [插件](#插件)

`Nacos/nɑ:kəʊs/` 是 `Dynamic Naming and Configuration Service` 的首字母简称：`⼀个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台`。

### 设计原则

- 极简原则，简单才好用，简单才稳定，简单才易协作。
- 架构⼀致性，⼀套架构要能适应开源、内部、商业化（公有云及专有云）3 个场景。
- 扩展性，以开源为内核，商业化做基础，充分扩展，方便用户扩展。
- 模块化，将通用部分抽象下沉，提升代码复用和健壮性。
- 长期主义，不是要⼀个能支撑未来 3 年的架构，而是要能够支撑 10 年的架构。
- 开放性，设计和讨论保持社区互动和透明，方便大家协作。

### 基本架构

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/nacos/Nacos基本架构.png" width="600px">
</div>

- 服务 (Service)

服务是指一个或一组软件功能（例如特定信息的检索或一组操作的执行），其目的是不同的客户端可以为不同的目的重用（例如通过跨进程的网络调用）。Nacos 支持主流的服务生态，如 Kubernetes Service、gRPC|Dubbo RPC Service 或者 Spring Cloud RESTful Service。

- 服务注册中心 (Service Registry)

服务注册中心，它是服务，其实例及元数据的数据库。服务实例在启动时注册到服务注册表，并在关闭时注销。服务和路由器的客户端查询服务注册表以查找服务的可用实例。服务注册中心可能会调用服务实例的健康检查 API 来验证它是否能够处理请求。

- 服务元数据 (Service Metadata)

服务元数据是指包括服务端点(endpoints)、服务标签、服务版本号、服务实例权重、路由规则、安全策略等描述服务的数据。

- 服务提供方 (Service Provider)

是指提供可复用和可调用服务的应用方。

- 服务消费方 (Service Consumer)

是指会发起对某个服务调用的应用方。

- 配置 (Configuration)

在系统开发过程中通常会将一些需要变更的参数、变量等从代码中分离出来独立管理，以独立的配置文件的形式存在。目的是让静态的系统工件或者交付物（如 WAR，JAR 包等）更好地和实际的物理运行环境进行适配。配置管理一般包含在系统部署的过程中，由系统管理员或者运维人员完成这个步骤。配置变更是调整系统运行时的行为的有效手段之一。

- 配置管理 (Configuration Management)

在数据中心中，系统中所有配置的编辑、存储、分发、变更管理、历史版本管理、变更审计等所有与配置相关的活动统称为配置管理。

- 名字服务 (Naming Service)

提供分布式系统中所有对象(Object)、实体(Entity)的 "名字" 到关联的元数据之间的映射管理服务，例如 ServiceName -> Endpoints Info, Distributed Lock Name -> Lock Owner/Status Info, DNS Domain Name -> IP List, 服务发现和 DNS 就是名字服务的 2 大场景。

- 配置服务 (Configuration Service)

在服务或者应用运行过程中，提供动态配置或者元数据以及配置管理的服务提供者。

### 整体架构

整体架构分为用户层、业务层、内核层和插件：

- 用户层主要解决用户使用的易用性问题。
- 业务层主要解决服务发现和配置管理的功能问题。
- 内核层解决分布式系统⼀致性、存储、高可用等核心问题。
- 插件解决扩展性问题。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/nacos/Nacos整体架构.png" width="600px">
</div>

#### 用户层 

- OpenAPI：暴露标准 Rest 风格 HTTP 接口，简单易用，方便多语言集成。
- Console：易用控制台，做服务管理、配置管理等操作。
- SDK：多语言 SDK，目前几乎支持所有主流编程语言。
- Agent：Sidecar 模式运行，通过标准 DNS 协议与业务解耦。
- CLI：命令行对产品进行轻量化管理，像 git ⼀样好用。 

#### 业务层

- 服务管理：实现服务 CRUD，域名 CRUD，服务健康状态检查，服务权重管理等功能。
- 配置管理：实现配置管 CRUD，版本管理，灰度管理，监听管理，推送轨迹，聚合数据等功能。
- 元数据管理：提供元数据 CURD 和打标能力，为实现上层流量和服务灰度非常关键。

#### 内核层 

- 插件机制：实现三个模块可分可合能力，实现扩展点 SPI 机制，用于扩展自己公司定制。
- 事件机制：实现异步化事件通知，SDK 数据变化异步通知等逻辑，是 Nacos 高性能的关键部分。
- 日志模块：管理日志分类，日志级别，日志可移植性（尤其避免冲突），日志格式，异常码+帮 助文档。
- 回调机制：SDK 通知数据，通过统⼀的模式回调用户处理。接口和数据结构需要具备可扩展性。
- 寻址模式：解决 Server IP 直连，域名访问，Nameserver 寻址、广播等多种寻址模式，需要可 扩展。
- 推送通道：解决 Server 与存储、Server 间、Server 与 SDK 间高效通信问题。
- 容量管理：管理每个租户，分组下的容量，防止存储被写爆，影响服务可用性。
- 流量管理：按照租户，分组等多个维度对请求频率，长链接个数，报文大小，请求流控进行控制。
- 缓存机制：容灾目录，本地缓存，Server 缓存机制，是 Nacos 高可用的关键。
- 启动模式：按照单机模式，配置模式，服务模式，DNS 模式模式，启动不同的模块。
- ⼀致性协议：解决不同数据，不同⼀致性要求情况下，不同⼀致性要求，是 Nacos 做到 AP 协 议的关键。
- 存储模块：解决数据持久化、非持久化存储，解决数据分片问题。

#### 插件

- Nameserver：解决 Namespace 到 ClusterID 的路由问题，解决用户环境与 Nacos 物理环境映射问题。
- CMDB：解决元数据存储，与三方 CMDB 系统对接问题，解决应用，人，资源关系。
- Metrics：暴露标准 Metrics 数据，方便与三方监控系统打通。
- Trace：暴露标准 Trace，方便与 SLA 系统打通，日志白平化，推送轨迹等能力，并且可以和计量计费系统打通。
- 接入管理：相当于阿里云开通服务，分配身份、容量、权限过程。
- 用户管理：解决用户管理，登录，SSO 等问题。
- 权限管理：解决身份识别，访问控制，角色管理等问题。
- 审计系统：扩展接口方便与不同公司审计系统打通。
- 通知系统：核心数据变更，或者操作，方便通过 SMS 系统打通，通知到对应人数据变更。