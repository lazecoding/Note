# 执行引擎

执行引擎是 Java 虚拟机的三个核心子系统之一。

### 字节码执行引擎

虚拟机是相对于物理机的概念，它们都有代码执行能力，区别在于物理机的执行引擎是直接建立在处理器、缓存、指令集和操作系统层面上的，而虚拟机的执行引擎是由软件实现的，因此虚拟机的执行引擎可以摆脱物理条件制约，定制指令集与执行引擎的结构体系，能够执行那些不被硬件直接支持的指令集格式。

Java 虚拟机将字节码装载到运行空间，但字节码无法够直接运行在操作系统之上，因为字节码指令不等价于本地机器指令，它内部包含的仅仅只是一些能够被 Java 虚拟机识别的字节码指令、符号表和其他辅助信息。执行引擎的任务就是将字节码指令编译/解释为对应平台上的本地机器指令，简单来说，Java 虚拟机中的执行引擎是将高级语言翻译为机器语言的译者。它的输入是字节码二进制流，处理过程是字节码解析执行的等效过程，输出的是执行结果，所以Java 虚拟机的执行引擎是字节码执行引擎。

### 运行时栈帧

Java 虚拟机以方法作为最基本的执行单元，"栈帧" 是虚拟机进行方法调用和方法执行背后的数据结构。

栈帧存储了方法的局部变量表、操作数栈、动态连接和方法返回地址等信息。每一个方法从调用开始至执行结束的过程，都对应着一个栈帧在虚拟机栈里面从入栈到出栈的过程。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/jvm/栈帧结构.png" width="600px">
</div>

#### 局部变量表

局部变量表是用于存放方法参数和方法内部定义的局部变量的数组。局部变量表的容量以变量槽（Variable Slot）为最小单位，Java 虚拟机规范没有明确指出一个变量槽应占用的内存空间大小，只是要求每个变量槽都应该可以存放 boolean、 byte、char、short、int、float、reference 或 returnAddress 这 8 种数据类型。
由于局部变量表是建立在虚拟机栈中，线程私有，所以无论读写两个连续的变量槽是否为原子操作，都不会引起数据竞争和线程安全问题。

#### 操作数栈

操作数栈也被称为操作栈，它是一个先入后出的栈。Java 虚拟机的解释执行引擎被称为 "基于栈的执行引擎"，这里的“栈”指的就是操作数栈 。当一个方法刚刚开始执行的时候，这个方法的操作数栈是空的，在方法的执行过程中，会有各种字节码指令往操作数栈中写入和提取内容，也就是出栈和入栈操作。

另外在概念模型中，两个不同栈帧作为不同方法的栈元素，是相互独立的。但是在大多虚拟机的实现里都会进行一些优化处理，让两个栈帧出现一部分重叠。让下面栈帧的部分操作数栈与上面栈帧的部分局部变量表重叠在一起，这样不仅可以节约空间，更重要的是在进行方法调用时可以直接共用一部分数据，无须进行额外的参数传递。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/jvm/栈帧数据共享.png" width="600px">
</div>

#### 动态连接

每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用，持有这个引用是为了支持方法调用过程中的动态连接。Class 文件的常量池中存有大量的符号引用，字节码中方法调用指令就以常量池里指向方法的符号引用作为参数。这些符号引用一部分会在类加载阶段或者第一次使用的时候就被转化为直接引用，这种转化被称为静态解析。另外一部分将在每一次运行期间都转化为直接引用，这部分就称为动态连接。

#### 方法返回地址

当一个方法开始执行后，只有两种方式退出这个方法：

- 执行引擎遇到任意一个方法返回的字节码指令会向上层的方法调用者传递返回值。
- 方法执行的过程中遇到了异常，并且这个异常没有在方法体内得到妥善处理，导致非正常退出，不会上层调用者提供任何返回值。

无论采用哪种方式，方法退出之后都必须返回到最初方法被调用时的位置，程序才能继续执行。一般来说，方法正常退出时，主调方法的 PC 计数器的值就可以作为返回地址，栈帧中很可能会保存这个计数器值。而方法异常退出时，返回地址是要通过异常处理器表来确定的，栈帧中就一般不会保存这部分信息。方法退出的过程实际上等同于把当前栈帧出栈，因此退出时可能执行的操作有：恢复上层方法的局部变量表和操作数栈，把返回值（如果有的话）压入调用者栈帧的操作数栈中，调整 PC 计数器的值以指向方法调用指令后面的一条指令等。

#### 附加信息

Java 虚拟机规范允许虚拟机实现增加一些规范里没有描述的信息到栈帧之中，例如与调试、性能收集相关的信息，这部分信息完全取决于具体的虚拟机实现。
