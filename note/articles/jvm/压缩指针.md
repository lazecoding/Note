# 压缩指针

一般对象指针（oop, ordinary object pointer）是 HotSpot 虚拟机的一个术语，表示受托管的对象指针。它的大小通常和本地指针是一样的。Java 应用程序和 GC 子系统会非常小心地跟踪这些受托管的指针，以便在销毁对象时回收内存空间，或是在对空间进行整理时移动（复制）对象。

### 为什么要压缩指针

对于 32 位机器，进程能使用的最大内存是 4GB。如果需要使用更大的堆内存，需要部署 64 位 JVM。在堆中，32 位的对象引用占 4 个字节，而 64 位的对象引用占 8 个字节。也就是说，64 位的对象引用大小是 32 位的 2 倍。

64 位Java 虚拟机在支持更大堆的同时，由于对象引用变大带来了性能问题：

- 增加了 GC 开销：64 位对象引用需要占用更多的堆空间，留给其他数据的空间将会减少，从而加快了 GC 的发生，更频繁的进行GC。
- 降低CPU缓存命中率： 64位对象引用增大了，CPU 能缓存的对象指针将会更少，从而降低了 CPU 缓存的效率。

### 什么是压缩指针

32 位最多可以表示 4GB，64位地址分为堆的基地址+偏移量，当堆内存 < 32GB 时候，在压缩过程中，把偏移量 /8 后保存到32位地址。在解压再把 32 位地址放大 8 倍，所以启用指针压缩的条件是堆内存要在 4GB * 8 = 32GB 以内。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/jvm/压缩指针.png" width="600px">
</div>

这也是为什么 Elasticsearch 单个节点 JVM 堆内存不要分配超过 32 GB 的原因。