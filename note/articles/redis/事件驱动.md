# 事件驱动

Redis 是一个事件驱动程序，需要处理两类事件：文件事件（file event）和事件事件（time event）。
- 文件事件：用于处理 Redis 服务器和客户端之间的网络IO。
- 时间事件：Redis 服务器中的一些操作（比如serverCron函数）需要在给定的时间点执行，而时间事件就是处理这类定时操作的。

### 文件事件

Redis 基于 Reactor 模式开发了自己的网络事件处理器： 这个处理器被称为文件事件处理器（file event handler）：
- 文件事件处理器使用 I/O 多路复用（multiplexing）程序来同时监听多个套接字， 并根据套接字目前执行的任务来为套接字关联不同的事件处理器。
- 当被监听的套接字准备好执行连接应答（accept）、读取（read）、写入（write）、关闭（close）等操作时， 与操作相对应的文件事件就会产生， 这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。

虽然文件事件处理器以单线程方式运行， 但通过使用 I/O 多路复用程序来监听多个套接字， 文件事件处理器既实现了高性能的网络通信模型， 又保持了 Redis 内部单线程设计的简单性。

#### 文件事件处理器构成

文件事件处理器由四个部分组成：套接字、I/O 多路复用程序、 文件事件分派器（dispatcher）和事件处理器。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/redis/文件事件处理器组成结构.png" width="400px">
</div>

文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答（accept）、写入、读取、关闭等操作时，就会产生一个文件事件。I/O 多路复用程序负责监听套接字，并向文件事件分派器传送那些产生了事件的套接字。

I/O 多路复用程序会将所有产生事件的套接字都入队到一个队列里面，然后通过这个队列，以有序（sequentially）、同步（synchronously）、每次一个套接字的方式向文件事件分派器传送套接字：当上一个套接字产生的事件被处理完毕之后（该套接字为事件所关联的事件处理器执行完毕），I/O 多路复用程序才会继续向文件事件分派器传送下一个套接字。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/redis/IO多路复用程序向文件事件分派器传输套接字.png" width="600px">
</div>

文件事件分派器接收 I/O 多路复用程序传来的套接字，并根据套接字产生的事件的类型，调用相应的事件处理器。

服务器会为执行不同任务的套接字关联不同的事件处理器，这些处理器是一个个函数，它们定义了某个事件发生时，服务器应该执行的动作。

#### 多路复用

Redis 的 I/O 多路复用程序的所有功能都是通过包装常见的 select 、 epoll 、 evport 和 kqueue 这些 I/O 多路复用函数库来实现的。每个多路复用函数库在 Redis 源码中都对应一个单独的文件，比如 ae_select.c、ae_epoll.c、ae_kqueue.c等。Redis 会根据不同的操作系统，按照不同的优先级选择多路复用技术。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/redis/多路复用事件响应框架.png" width="600px">
</div>

### 时间事件

