# Redis 怎么慢了

Redis 具有极高性能和吞吐量，但有的时候操作 Redis 响应却很慢，这时候我们要逐步排查。响应变慢存在两方面可能：

- 客户端与服务器之间的存在网络问题，如网络数据包在传输时存在延迟、丢包等情况。
- 服务器自身问题。

当排除网络问题的情况下，我们主要分析服务器自身可能存在的问题。

### 执行复杂度高的命令

首先查看一下 Redis 的慢日志。Redis 提供了慢日志命令的统计功能，通过以下设置可以查看有哪些命令在执行时延迟比较大。

```C
# 命令执行超过 5 毫秒记录慢日志（单位是微妙）
CONFIG SET slowlog-log-slower-than 5000
# 只保留最近 1000 条慢日志
CONFIG SET slowlog-max-len 1000
```

通过慢日志记录，可以知道在什么时间执行哪些命令比较耗时。如果你的服务请求量并不大，但 Redis 实例的 CPU 使用率很高，很有可能是使用了复杂度高的命令导致的。

建议：
- 避免使用复杂度较高的命令。
- 数据少量多次地取，让 Redis 可以及时处理返回。

### 存储大key

如果查询慢日志发现，并不是复杂度较高的命令导致的，例如是 SET、DELETE 操作出现在慢日志记录中，那么就可能存在写入了大 key 的情况。

Redis 在写入数据时，需要为新的数据分配内存，当从 Redis 中删除数据时，它会释放对应的内存空间。如果一个 key 写入的数据非常大，Redis 在分配内存时也会比较耗时。同样的，当删除这个 key 的数据时，释放内存也会耗时比较久。

Redis 也提供了扫描大key的方法：

```C
redis-cli -h $host -p $port --bigkeys -i 0.01
```

建议：
- 避免写入大 key。
- Redis 4.0 以上版本，用 UNLINK 命令替代 DEL，此命令可以把释放 key 内存的操作，放到后台线程中去执行，从而降低对 Redis 的影响。
- Redis 6.0 以上版本，可以开启 lazy-free 机制（lazyfree-lazy-user-del = yes），在执行 DEL 命令时，释放内存也会放到后台线程中执行。
- 即便如此，依然不建议写入大 key,在很多场景下，大 key 会产生性能问题。例如，在分片集群模式下，对于数据的迁移也会有性能影响，以及数据过期、数据淘汰。

### 集中过期

### 内存达到上限

当我们把 Redis 当做纯缓存使用时，通常会给这个实例设置一个内存上限 maxmemory，并设置一个数据淘汰策略。

当 Redis 内存达到 maxmemory 后，每次写入新的数据之前，Redis 必须先从实例中淘汰一部分数据，让整个实例的内存维持在 maxmemory 之下，然后才能把新数据写进来。淘汰数据的逻辑也是需要消耗时间的，而具体耗时的长短，要取决于你配置的淘汰策略。

需要注意的是，Redis 的淘汰数据的逻辑与删除过期 key 的一样，也是在命令真正执行之前执行的，也就是说它也会增加我们操作 Redis 的延迟，而且，写 OPS 越高，延迟也会越明显。另外，如果此时你的 Redis 实例中还存储了大 key，那么在淘汰删除大 key 释放内存时，也会耗时比较久。

建议：
- 避免存储大 key，降低释放内存的耗时。
- 淘汰策略改为随机淘汰，随机淘汰比 LRU 要快很多（视业务情况调整）。
- 拆分实例，把淘汰 key 的压力分摊到多个实例上。
- Redis 4.0 以上版本，开启 layz-free 机制，把淘汰 key 释放内存的操作放到后台线程中执行。

### fork耗时严重


为了保证 Redis 数据的安全性，我们可能会开启后台 RDB 和 AOF rewrite。当 Redis 开启了后台 RDB 和 AOF rewrite 后，在执行时，它们都需要主进程 fork 出一个子进程进行数据的持久化。fork 在执行过程中，主进程需要拷贝自己的内存页表给子进程，如果这个实例很大，那么这个拷贝的过程也会比较耗时。而且这个 fork 过程会消耗大量的 CPU 资源，在完成 fork 之前，整个 Redis 实例会被阻塞住，无法处理任何客户端请求。

建议：
- 控制 Redis 实例的内存：尽量在 10G 以下，执行 fork 的耗时与实例大小有关，实例越大，耗时越久。
- 合理配置数据持久化策略：在 slave 节点执行 RDB 备份，推荐在低峰期执行，而对于丢失数据不敏感的业务（例如把 Redis 当做纯缓存使用），可以关闭 AOF 和 AOF rewrite。
- Redis 实例不要部署在虚拟机上：fork 的耗时也与系统也有关，虚拟机比物理机耗时更久。
- 降低主从库全量同步的概率：适当调大 repl-backlog-size 参数，避免主从全量同步。

### 绑定CPU

### 开启AOF

### 使用Swap

### 网卡负载过高
