# 持久化

Redis 是个内存数据库，为了避免服务器进程退出导致数据丢失，Redis 提供了持久化功能。

Redis 提供了两种基础持久化机制和一种混合持久化机制。
- `RDB 持久化`：快照方式，将数据库数据进行二进制序列化全量保存到 RDB 文件中。 
- `AOF 持久化`：日志方法，基于写指令记录数据库数据，增量持久化。
- `混合持久化`：RBD 持久化和 AOF 持久化混合持久化。

### AOF

除了 RDB 持久化，Redis 还提供了 AOF（Append Only File）持久化，AOF 持久化通过保存写命令来记录数据库状态。

#### AOF&ensp;持久化的实现

AOF 持久化功能的实现可以分为命令追加（append）、文件写入、文件同步（sync）三个步骤。

当 AOF 持久化功能处于打开状态时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的 `aof_buf 缓冲区` 的末尾。

Redis 的服务器进程就是一个事件循环（loop），每次结束一个事件循环之前，服务器都会调用 flushAppendOnlyFile 函数， 考虑是否需要将 aof_buf 缓冲区中的内容写入和保存到 AOF 文件里面。

程序对 AOF 文件的写入，实际上写到了内核为文件描述符分配的内存缓冲区，等到缓冲区空间被填满或者超出一定时限，才真正地将缓冲区地数据写入到磁盘文件中。这意味着，如果机器宕机会导致缓冲区地数据丢失，为此操作系统提供了 fsync 和 fdatasync 两个同步函数用于强制将缓冲区地数据写入到磁盘文件中。

为了保证数据地安全性，可以通过设置服务器` appendfsync` 选项来控制 flushAppendOnlyFile 函数的行为。
- always：将 aof_buf 缓冲区中的所有内容写入并同步到 AOF 文件。
- everysec（默认）：将 aof_buf 缓冲区中的所有内容写入到 AOF 文件，如果上次同步 AOF 文件的时间距离现在超过一秒钟，那么再次对 AOF 文件进行同步，并且这个同步操作是由一个线程专门负责执行的。
- no：将 aof_buf 缓冲区中的所有内容写入到 AOF 文件，但并不对 AOF 文件进行同步，何时同步由操作系统来决定。

#### AOF&ensp;文件载入和数据还原

AOF 文件包含重建数据库状态所有的写命令，只需要服务器读取并重现命令即可还原数据。

#### AOF&ensp;重写

AOF 持久化是基于写命令追加的，随着服务器运行，文件体积越来越大，数据还原时间也越来越长。为了解决这个问题，Redis 提供了 AOF 文件重写功能，生成一个没有冗余命令而且数据库状态相同的 AOF 文件。

AOF 重写程序会进行大量写入操作，调用线程会陷入长时间的阻塞状态，因此 Redis 服务器通过单独的线程来进行 AOF 重写。同时为了防止 AOF 重写过程中，新的命令请求导致重写的 AOF 文件和原来的 AOF 文件不一种，Redis 服务器参照 AOF 缓冲区也给 AOF 重写功能设置了一个 AOF 重写缓冲区，命令处理器同时会把写命令发送给 AOF 缓冲区 和 AOF 重写缓冲区。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/redis/AOF日志写入流程.png" width="600px">
</div>

### 混合持久化
