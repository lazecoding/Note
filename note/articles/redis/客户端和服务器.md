# 客户端和服务器

Redis 是典型的一对多的服务器程序：一个服务器可以和多个客户端建立连接。通过使用 I/O 多路复用实现的文件事件处理器，Redis 服务器使用单进程单线程的方式处理命令，并与多个客户端进行网络通信。

### 通信协议

RESP 是 Redis 序列化协议（Redis Serialization Protocol）的简写，它是文本协议，优势在于实现过程异常简单、解析性能好、有可读性。

RESP 将传输的结构分为 5 种最小单元，单元结束的时候统一加上回车换行符号\r\n。
- 单行字符串以 `+` 符号开头。
- 多行字符串以 `$` 符号开头，后跟字符串长度。 
- 整数值以 `:` 符号开头，后跟整数的字符串形式。
- 错误消息以 `-` 符号开头。
- 数组以 `*` 号开头，后跟数组的长度。

单行字符串 hello world

```C
+hello world\r\n
```

多行字符串 hello world

```C
$11\r\nhello world\r\n
```

整数 1024

```C
:1024\r\n
```

错误 参数类型错误

```C
-WRONGTYPE Operation against a key holding the wrong kind of value
```

数组 [1,2,3]

```C
*3\r\n:1\r\n:2\r\n:3\r\n
```

NULL 用多行字符串表示，不过长度要写成-1。

```C
$-1\r\n
```

空串 用多行字符串表示，长度填 0，两个\r\n 之间,隔的是空串。

```C
$0\r\n\r\n
```

### 服务器启动流程

Redis 服务器启动大致流程如下：

```C
// 初始化配置为默认值
initServerConfig();

// 载入配置文件（options 是前面解析配置文件给定的选项）
loadServerConfig(configfile,options);

// 创建并初始化服务器数据结构、创建事件处理器、初始化数据库等
initServer()

// 运行事件处理器，一直到服务器关闭为止
aeSetBeforeSleepProc(server.el,beforeSleep);
aeMain(server.el);

// 服务器关闭，停止事件循环
aeDeleteEventLoop(server.el);
```

### 命令请求的执行过程

一个命令请求从发送到获得回复的过程中， 客户端和服务器需要完成一系列操作。
- 建立连接
- 发送命令请求
- 读取命令请求
- 查找命令实现
- 执行预备操作
- 调用命令实现函数
- 执行后续工作
- 将命令回复发送给客户端
- 客户端接收并打印命令回复

#### 建立连接

当客户端向服务器建立 socket 连接时，aeEventLoop 会调用 acceptTcpHandler 处理函数，服务器会为每个链接创建一个 Client 对象，并创建相应文件事件来监听 socket 的可读事件，并指定事件处理函数。

> Redis 服务器启动时，会调用 initServer 方法，首先会建立 Redis 自己的事件机制 eventLoop，然后在其上注册周期时间事件处理器，最后在所监听的 socket 上创建文件事件处理器，监听 socket 建立连接的事件。

#### 发送命令请求

当客户端键入一个命令请求，客户端会将这个命令转换成协议格式，通过连接到服务器的套接字发送命令请求。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/redis/RDB文件结构.png" width="600px">
</div>

#### 读取命令请求

当客户端通过 socket 发送来数据后，服务器会调用 readQueryFromClient 方法，readQueryFromClient 方法会调用 read 方法从 socket 中读取数据到输入缓冲区中，分析输入缓冲区的命令请求，调用命令执行器。

#### 查找命令实现
#### 执行预备操作
#### 调用命令实现函数
#### 执行后续工作
#### 将命令回复发送给客户端
#### 客户端接收并打印命令回复
