# HTTPS

- 目录
  - [加密技术](#加密技术)
    - [对称加密](#对称加密)
    - [非对称加密](#非对称加密)
    - [单向加密](#单向加密)
  - [数字签名](#数字签名)
  - [数字证书](#数字证书)
    - [客户端发出请求](#客户端发出请求)
    - [服务器回应](#服务器回应)
    - [客户端回应](#客户端回应)
    - [服务器回应](#服务器回应)

HTTPS 通过对 HTTP 进行 SSL/TLS 加密实现安全通信，本文阐述其背后的安全保障。

### 加密技术

信息安全主要包括以下五方面的内容，即保证信息的保密性、真实性、完整性、未授权拷贝和所寄生系统的安全性。

加密技术是最常用的安全保密手段，利用技术手段把重要的数据变为乱码（加密）传送，到达目的地后再用相同或不同的手段还原（解密）。

加密技术主要分为三种：对称加密、非对称加密和单向加密。

#### 对称加密

对称加密，也叫共享密钥，顾名思义，这种加密方式用相同的密钥进行加密和解密。优秀的对称加密算法，如 Rijndael 算法、三重 DES 算法，它们在算法上是无懈可击的，拥有巨大的密钥空间，
基本无法暴力破解，而且加密过程相对快速。

但是，一切对称加密算法的软肋在于密钥的配送。加密和解密用同一个密钥，发送方必须设法把密钥发送给接收方。如果窃听者有能力窃取密文，肯定也可以窃取密钥，那么再无懈可击的算法依然不攻自破。

#### 非对称加密

非对称加密，又称公开密钥加密，它的思路就是把加密密钥和解密密钥分开，而且加密算法是可逆的(公钥加密，私钥解密；私钥加密，公钥解密)。发送方只需要把公钥传送给对方，接收方用公钥加密数据并传输给发送方，
发送方用私钥解密获取密文。窃听者即使拿到公钥和加密数据也无法解密。

在实际应用中，非对称性加密的运算速度要比对称性加密慢很多的，所以传输大量数据时，一般不会用公钥直接加密数据，而是加密对称性加密的密钥，传输给对方，然后双方使用对称性加密算法传输数据。

#### 单向加密

单向加密，又称为不可逆加密算法，在加密过程中不使用密钥，明文由系统加密处理成密文，密文无法解密。

其实，严格意义上单向加密并不是加密算法，而是一种摘要算法，用于验证数据的完整性，如 MD5、SHA1。如果一种算法是加密算法，就应该不仅能够加密数据，而且应该能够还原数据。

### 数字签名

数字签名也利用了非对称性密钥的特性，但是和公钥加不一样：发送方用私钥加密数据，然后把加密的数据公布出去，这就是数字签名。

你可能问，这有什么用，公钥可以解开私钥加密，我还加密发出去，不是多此一举吗？

是的，但是数字签名的作用本来就不是保证数据的机密性，而是 `证明你的身份，证明这些数据确实是由你本人发出的`。你想想，你的私钥加密的数据，只有你的公钥才能解开，
那么如果一份加密数据能够被你的公钥解开，不就说明这份数据是你（私钥持有者）本人发布的吗？

当然，加密数据仅仅是一个签名，签名应该和数据一同发出，具体流程应该是：

- Bob 生成公钥和私钥，然后把公钥公布出去，私钥自己保留。
- Bob用私钥加密数据作为签名，然后将数据附带着签名一同发布出去。
- Alice 收到数据和签名，需要检查此份数据是否是 Bob 所发出，于是用 Bob 之前发出的公钥尝试解密签名，将收到的数据和签名解密后的结果作对比，如果完全相同，说明数据没被篡改，且确实由 Bob 发出。

有意思的来了，数字签名就是验证对方身份的一种方式，但是前提是对方的身份必须是真的。这似乎陷入死循环，要想确定对方的身份，必须有一个信任的源头，否则的话，再多的流程也只是在转移问题，
而不是真正解决问题。

### 数字证书

CA 是 CertificateAuthority 的缩写，也叫 "证书授权中心"。它是负责管理和签发证书的第三方机构，作用是检查证书持有者身份的合法性，并签发证书，以防证书被伪造或篡改。
CA 证书其实就是 `公钥 + 签名`，引入可信任的第三方，是终结信任循环的一种可行方案。

证书认证的流程大致如下：

- Bob 去可信任的认证机构证实本人真实身份，并提供自己的公钥。
- Alice 想跟 Bob 通信，首先向认证机构请求 Bob 的公钥，认证机构会把一张证书（Bob 的公钥以及机构对其公钥的签名）发送给 Alice。
- Alice 检查签名，确定该公钥确实由这家认证机构发送，中途未被篡改。
- Alice 通过这个公钥加密数据，开始和 Bob 通信。

CA 证书很广泛，SSL/TLS 是 CA 证书中的一种。SSL/TLS 建立连接需要 `四次握手`。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/TLS四次握手.png" width="600px">
</div>

#### 客户端发出请求

- 首先，客户端先向服务器发出加密通信的请求，这被叫做 ClientHello 请求。

  在这一步，客户端主要向服务器提供以下信息：
  i.  支持的协议版本，比如TLS 1.0版。
  ii. 一个客户端生成的随机数，稍后用于生成"对话密钥"。
  iii. 支持的加密方法，比如RSA公钥加密。
  iiii. 支持的压缩方法。

#### 服务器回应

- 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
- 确认使用的加密方法，比如RSA公钥加密，返回加密公钥。
- 服务器证书。

#### 客户端回应

- 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。
- 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。
- 使用约定好的 HASH 计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。

#### 服务器回应

- 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证 HASH 是否与浏览器发来的一致。
- 使用密码加密一段握手消息，发送给浏览器。

故此，HTTPS 建立安全连接需要 `七次握手`，安全是很安全，但即便是通过正规机构认证的 HTTPS 站点，也不意味着可信任，只能说明其数据传输是安全的。技术的能力是有限的，还是要提高个人的安全意识。


