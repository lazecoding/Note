# 应用层

- 目录
    - [进程通信](#进程通信)
    - [进程寻址](#进程寻址)
    - [应用层协议](#应用层协议)
    - [Web 和 HTTP](#Web-和-HTTP)
        - [建立连接](#建立连接)
        - [HTTP 报文](#HTTP-报文)
    - [DNS](#DNS)
        - [域名](#域名)
        - [DNS 提供的服务](#DNS-提供的服务)
        - [DNS 解析过程](#DNS-解析过程)

网络应用是网络存在的理由，如果不能构想出有用的应用，也就没有必要去设计支持它们的网络协议了。

### 进程通信

在构建网络应用之前，首先要了解多个端系统是如何互相通信的。在操作系统层面，进行通信的实际上是进程，而不是程序。一个进程可以被认为是允许在端系统中的一个程序，在两个不同端系统上的进程，通过网络交换报文而互相通信。

进程通过一个叫套接字（socket）的软件接口向网络发送报文和从网络接收报文。套接字是应用层与传输层之间的接口，它是一个建立网络应用程序的可编程接口，因此套接字也被成为应用程序和网络之间的应用程序编程接口。开发者可以控制套接字在应用层端的一切，但对该套接字在传输层端几乎没有控制权。

### 进程寻址

一台主机上运行的进程为了向另一台主机上允许的程序发送分组，接口进程需要有一个地址，在因特网中主机由 IP 地址标识。除了需要知道目的地的主机地址外，还必须指定运行在接收主机上的接收进程（具体说，接收套接字）。一般通过端口号来实现这个目的，如 Web 服务器用端口号 80 标识。

### 应用层协议

应用层协议定义了运行在不同端系统上的应用程序如何相互传递报文，特别是应用层协议定义了：

- 交换的报文类型，例如请求报文和响应报文；
- 各种报文类型的语法，如报文中各个字段及这些字段是如何描述的；
- 字段的语义，即这些字段值包含的信息的含义；
- 一个进程何时以及如何发送报文，对报文进行响应的规则。

### Web 和 HTTP

Web 是一种客户端 - 服务器应用，它允许客户按照需求从 Web 服务器获取文档。HTTP 是 Web 的应用层协议，称超文本传输协议（HyperText Transfer Protocol）。客户端程序和服务器程序通过交换 HTTP 报文进行会话，HTTP 定义了这些报文的结构以及客户和服务器进行报文交换的方式。

HTTP 使用 TCP 作为它的支持运输协议，HTTP 客户端首先发起一个与服务器的 TCP 连接。连接一旦建立，该浏览器和服务器进程就可以通过套接字接口通信。需要注意的是，HTTP 是无状态协议，即 HTTP 服务器不保存关于客户端的任何信息。

#### 建立连接

HTTP 使用 TCP 作为它的支持运输协议，这意味着发起 HTTP 请求需要建立 TCP 连接。

建立 TCP 连接需要 "三次握手"，即客户端向服务器发送一个小 TCP 报文段，服务器用一个小的 TCP 报文段做出确认和响应，最后客户端向服务器返回确认（传输层详谈）。

这意味着，发起 HTTP 请求必须为请求的对象建立和维护一个连接。每个连接在客户端和服务器


#### HTTP 报文

用于 HTTP 协议交互的信息被称为 HTTP 报文，HTTP 报文本身是由多行数据构成的字符串文本。HTTP 报文大致可以分为报文首部和报文主体两部分，两者由空行划分。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/HTTP报文基本格式.png" width="600px">
</div>

HTTP 报文有两种：请求报文和响应报文。

- 请求报文

请求报文结构：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/请求报文结构.png" width="600px">
</div>

请求报文实例：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/请求报文实例.png" width="600px">
</div>

- 响应报文

响应报文结构：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/响应报文结构.png" width="600px">
</div>

响应报文实例：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/响应报文实例.png" width="600px">
</div>

请求报文和响应报文的首部内容由以下数据组成：

- `请求行`：包含用于请求的方法，请求的 URI 和 HTTP 版本。
- `状态行`：包含表明响应结果的状态码、原因短语和 HTTP 版本。
- `首部字段`：包含表示请求和响应的各种条件和属性的各类首部（一般有四种首部：通用首部、请求首部、响应首部、实体首部）。
- `其他`：可能包含 HTTP 的 RFC 中未定义的首部（如 Cookie）。

报文主体用于传输请求或响应的实体主体。通常报文主体等于实体主体，只有当传输中进行编码操作，实体主体的内容发送变化，报文主体和实体主体才会不一致。

- `报文`：是 HTTP 通信的基本单位，由 8 位字节流组成，通过 HTTP 通信传输。
- `实体`：作为请求或响应的有效载荷数据被传输，其内容由实体首部和实体主体组成。

报文主体并不是必须的，如 GET 类型的请求报文。

### DNS

由于 IP 地址具有不方便记忆并且不能显示地址组织的名称和性质等缺点，人们设计出了域名，并通过 DNS（域名系统）来将域名和 IP 地址相互映射，使人更方便地访问互联网，而不用去记住能够被机器直接读取的 IP 地址数串。

DNS（Domain Name System，域名系统）是互联网的一项服务。它作为将域名和 IP 地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。

#### 域名

域名（Domain Name），又称网域，是由一串用点分隔的名字组成的 Internet 上某一台计算机或计算机组的名称，用于在数据传输时对计算机的定位标识（有时也指地理位置）。

域名具有层次结构，采用层次树状结构的命名方法。任何一个连接在因特网上的主机或路由器，都有一个唯一的层次结构的名字，即域名。这里，"域" 是名字空间中一个可被管理的划分。从语法上讲，每一个域名都是由标号序列组成，而各标号之间用 `.`(小数点)隔开。域名可以划分为各个子域，子域还可以继续划分为子域的子域，这样就形成了顶级域、主域名、子域名等。关于域名层次结构如下图：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/域名层级结构.png" width="600px">
</div>


#### DNS 提供的服务

DNS 提供的服务是将域名转换为 IP 地址。它是一个由分层的 DNS 服务器实现的分布式数据库，运行在 UDP 之上，使用 53 号断开。

域名是分层结构，DNS 服务器也是对应的层级结构，域名解析过程涉及 4 个 DNS 服务器，分别如下：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/DNS各级别服务器.png" width="600px">
</div>

注意：

- 每个层的域名上都有自己的域名服务器，最顶层的是根域名服务器。
- 每一级域名服务器都知道下级域名服务器的IP地址，以便于一级一级向下查询。

#### DNS 解析过程

DNS 查询的结果通常会在本地域名服务器中进行缓存，如果本地域名服务器中有缓存的情况下，则会跳过如下 DNS 查询步骤，很快返回解析结果。下面的示例则概述了本地域名服务器没有缓存的情况下，DNS 查询所需的 8 个步骤：

- 用户在 Web 浏览器中输入 `example.com`， 则由本地域名服务器开始进行递归查询。
- 本地域名服务器采用迭代查询的方法，向根域名服务器进行查询。
- 根域名服务器告诉本地域名服务器，下一步应该查询的顶级域名服务器 `.com TLD` 的 IP 地址。
- 本地域名服务器向顶级域名服务器 `.com TLD` 进行查询。
- `.com TLD` 服务器告诉本地域名服务器，下一步查询 `example.com` 权威域名服务器的IP地址。
- 本地域名服务器向 `example.com` 权威域名服务器发送查询。
- `example.com` 权威域名服务器告诉本地域名服务器所查询的主机 IP 地址。
- 本地域名服务器最后把查询的IP地址响应给 web 浏览器。

一旦 DNS 返回了 `example.com` 的 IP 地址，浏览器就能够发出对网页的请求：

- 浏览器向 IP 地址发出 HTTP 请求。
- 该 IP 处的 Web 服务器返回要在浏览器中呈现的网页。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/DNS解析过程.png" width="600px">
</div>

注意：操作系统中的 HOSTS 文件可以配置域名和对应 IP 地址的，它优先于 DNS 服务器，但低于 DNS 缓存。

