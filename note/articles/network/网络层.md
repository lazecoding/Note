# 网络层

- 目录
  - [转发和路由选择](#转发和路由选择)
  - [虚电路和数据表网络](#虚电路和数据表网络)
  - [路由器](#路由器)
    - [路由表和转发表](#路由表和转发表)
  - [数据包](#数据包)
    - [数据包分片](#数据包分片)
  - [编址](#编址)
    - [子网掩码](#子网掩码)
    - [CIDR 和 VLSM](#CIDR-和-VLSM)
    - [IPv6](#IPv6)

网络层提供了路由和寻址的功能，使两终端系统能够互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。

### 转发和路由选择

网络层的作用是将分组从一台主机移动到另一个主机，因此需要两个极其重要的功能：转发和路由选择。

- `转发`：当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路。
- `路由选择`：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。

每台路由器都具有一张`转发表`，路由器通过检查到达分组首部字段的值来转发分组，然后使用该值在路由器的转发表中索引查询。存储在转发表项目中的该首部的值指出了该分组将被转发的路由器的输出链路接口。

`分组交换机`是一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。基于链路层字段中的值决定转发的分组交换机叫做`链路层交换机`，其余分组交换机称为`路由器`，基于网络层字段中的值做转发决定。

因特网的网络层提供了`尽力而为`的网络服务，其实就是没特殊服务，分组发送和接收顺序是无法保证的，发送的分组也不一定能够最终交付，它是一种简化的网络层服务。

### 虚电路和数据表网络

仅在网络层提供连接服务的网络称为`虚电路网络`，仅在网络层提供无连接服务的网络被称为`数据报网络`。

因特网是个数据报网络，每当一个端系统要发送分组，它就为该分组加上目的端系统的地址，然后将该分组推进网络中。分组从源到目标通过一系列路由器传递，这些路由器没台都使用分组的目的地址来转发该分组。

### 路由器

通用路由器体系结构：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/通用路由器体系结构.png" width="600px">
</div>

- `输入端口`：输入端口提供将输入的物理链路与路由器相连的功能；输入端口还要完成查找功能，通过查询转发表决定路由器的输出端口；控制分组从输入端口转发到路由选择处理器。
- `交换结构`：交换结构连接路由器的输入端口和输出端口，里面包含了`转发表`。
- `输出端口`：存储从交换结构接收的分组，并提供执行必要链路层和物理层给你在输入链路上传输这些分组。
- `路由器选择处理器`：执行路由选择协议，维护路由表以及连接的链路状态信息，并未路由器计算转发表，以及网络管理功能。

#### 路由表和转发表

区分路由表和转发表首先路由和转发之间的区别。转发是路由器一旦接收到数据包后将采取的一系列操作，包括查看其目标地址，查询表并按照以下方式确定的方向发送数据包；而路由是指构建转发表的过程。

转发表通常需要被构造，以优化的转发数据包，其中包含更多的信息，例如MAC地址时，查找的地址的过程。相反，路由表通常专注于计算拓扑的变化，路由表中的条目通常更简洁，仅包括下一跳的IP。

### 数据报

网络层分组被称为数据包，一个 IPv4 数据包格式如下：


<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/IPv4数据包格式.png" width="600px">
</div>

- `版本号`：4 位，规定了数据包的 IP 协议版本（例子中是 IPv4）。
- `首部长度`：4 位，即首部占用了多少字节。
- `服务类型`：8 位，只有在使用区分服务时，这个字段才起作用。
- `数据包长度`：这是 IP 数据包的总长度（首部加上数据），字节单位。
- `标识、标志、偏移`：IP 分片相关，IPv6 已禁止在路由器上对分组分片。
- `寿命`：TTL（Time-To-Live），数据包每经过一个路由器 TTL 减一，当 TTL 字段为 0，该数据包必须丢弃。
- `协议`：指定了数据包的数据部分应该交有传输层的哪个协议（TCP/UDP）。
- `首部校验和`：校验数据包是否存在错误。
- `源和目的 IP 地址`：源主机地址和目标主机地址。
- `选项`：选项字段允许 IP 首部被扩展。

#### 数据包分片

不用的链路层协议可能承载的分组长度不一定相同，一个链路层帧能承载的最大数据量叫做最大传送单元（Maximum Transmission Unit,MTU）。为了服务不同协议，网络层将数据包中数据分片成多个较小数据包分片，
用单独的链路层帧封装这些较小二点 IP 数据包，然后向输出链路发送这些帧。

### 编址

在计算机通信中，为了识别通信对端，必须要有一个类似于地址的识别码进行标识，即 IP 地址。IP 地址用于 "连接到网络中的所有主机中识别出进行通信的目标地址"。在 TCP/IP 通信中所有主机或路由器必须设定自己的 IP 地址。

当前网络以 IPv4 为主，其 IP 地址由 32 位正整数来标识。TCP/IP 通信要求将这样的 IP 地址分配给每个参与通信的主机。

IP 地址在计算机内部以二进制的方式被处理，为了可读，人们将 32 位 IP 地址以每 8 位为一组，分成 4 组，每组以 "." 隔开，再将每组数转换成十进制。

IP 地址由 "网络标识（网络地址）" 和 "主机标识（主机地址）" 两部分组成。由此，可以保证再相连的网络中每台主机的 IP 地址都不会互相重叠，即 IP 地址具有唯一性。

IP 地址中网络地址和主机地址是通过子网掩码来区分的，如 255.255.255.0，即连续 24 个 1 和 8 个 连续的 0，也写作 /24。这表示 IP 地址的前 24 位是网络地址，后 8 为是主机地址。

IP 地址分为四个级别，分别是 A 类、B 类、C 类、D 类。它是根据 IP 地址中 1-4 位的对其网络标识和主机标识进行区分的。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/IP地址分类.png" width="600px">
</div>

- `A 类地址`：0 开头的地址，1-8 位是它的网络标识。
- `B 类地址`：10 开头的地址，1-16 位是它的网络标识。
- `C 类地址`：110 开头的地址，1-24 位是它的网络标识。
- `D 类地址`：1110 开头的地址，1-32 位是它的网络标识。

#### 子网掩码

刚刚说过，IP 地址中网络地址和主机地址是通过子网掩码来区分的，如 C 类地址的子网掩码是 255.255.255.0，即连续 24 个 1 和 8 个 连续的 0，也写作 /24。这表示 IP 地址的前 24 位是网络地址，后 8 为是主机地址。

子网掩码只有一个作用：将某个 IP 地址划分成网络地址和主机地址两部分。通俗的话，就是用来分割子网和区分那些ip是同一个网段的，那些不是同一网段的

#### CIDR 和 VLSM

CIDR 意为 "无类型域间路由"，采用任意长度分割 IP 地址的网络标识和主机标识，不受 IP 地址分类的限制自由分配。

VLSM 意味可变长子网掩码，可以自定义子网掩码长度的机制。

如将一个 C 类地址的网络标识扩展成多个不同网络标识的网络（/24，/25，/26 等），每个网络标识下可以容纳不同数量的主机，这也就扩展了一个网络可以容纳的主机数量。

#### IPv6

IPv6 是一种为了从根本上解决 IPv4 地址耗尽的标准化网际协议。IPv4 的地址长度为 32 比特，而 IPv6 地址长度是原来的 4 倍，即 128 比特，一般写成 8 个 16 位字节。