# 网络层

- 目录
  - [转发和路由选择](#转发和路由选择)
  - [虚电路和数据表网络](#虚电路和数据表网络)
  - [路由器](#路由器)
    - [路由表和转发表](#路由表和转发表)
  - [数据包](#数据包)
    - [数据包分片](#数据包分片)
  - [编址](#编址)
    - [子网掩码](#子网掩码)
    - [CIDR 和 VLSM](#CIDR-和-VLSM)
    - [IPv6](#IPv6)
  - [路由选择](#路由选择)
    - [静态路由和动态路由](#静态路由和动态路由)
    - [路由选择算法](#路由选择算法)
      - [RIP](#RIP)
      - [OSPF](#OSPF)
      - [BGP](#BGP)

网络层提供了路由和寻址的功能，使两终端系统能够互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。

### 转发和路由选择

网络层的作用是将分组从一台主机移动到另一个主机，因此需要两个极其重要的功能：转发和路由选择。

- `转发`：当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路。
- `路由选择`：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。

每台路由器都具有一张`转发表`，路由器通过检查到达分组首部字段的值来转发分组，然后使用该值在路由器的转发表中索引查询。存储在转发表项目中的该首部的值指出了该分组将被转发的路由器的输出链路接口。

`分组交换机`是一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。基于链路层字段中的值决定转发的分组交换机叫做`链路层交换机`，其余分组交换机称为`路由器`，基于网络层字段中的值做转发决定。

因特网的网络层提供了`尽力而为`的网络服务，其实就是没特殊服务，分组发送和接收顺序是无法保证的，发送的分组也不一定能够最终交付，它是一种简化的网络层服务。

### 虚电路和数据表网络

仅在网络层提供连接服务的网络称为`虚电路网络`，仅在网络层提供无连接服务的网络被称为`数据报网络`。

因特网是个数据报网络，每当一个端系统要发送分组，它就为该分组加上目的端系统的地址，然后将该分组推进网络中。分组从源到目标通过一系列路由器传递，这些路由器没台都使用分组的目的地址来转发该分组。

### 路由器

通用路由器体系结构：

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/通用路由器体系结构.png" width="600px">
</div>

- `输入端口`：输入端口提供将输入的物理链路与路由器相连的功能；输入端口还要完成查找功能，通过查询转发表决定路由器的输出端口；控制分组从输入端口转发到路由选择处理器。
- `交换结构`：交换结构连接路由器的输入端口和输出端口，里面包含了`转发表`。
- `输出端口`：存储从交换结构接收的分组，并提供执行必要链路层和物理层给你在输入链路上传输这些分组。
- `路由器选择处理器`：执行路由选择协议，维护路由表以及连接的链路状态信息，并未路由器计算转发表，以及网络管理功能。

#### 路由表和转发表

区分路由表和转发表首先路由和转发之间的区别。转发是路由器一旦接收到数据包后将采取的一系列操作，包括查看其目标地址，查询表并按照以下方式确定的方向发送数据包；而路由是指构建转发表的过程。

转发表通常需要被构造，以优化的转发数据包，其中包含更多的信息，例如MAC地址时，查找的地址的过程。相反，路由表通常专注于计算拓扑的变化，路由表中的条目通常更简洁，仅包括下一跳的IP。

### 数据报

网络层分组被称为数据包，一个 IPv4 数据包格式如下：


<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/IPv4数据包格式.png" width="600px">
</div>

- `版本号`：4 位，规定了数据包的 IP 协议版本（例子中是 IPv4）。
- `首部长度`：4 位，即首部占用了多少字节。
- `服务类型`：8 位，只有在使用区分服务时，这个字段才起作用。
- `数据包长度`：这是 IP 数据包的总长度（首部加上数据），字节单位。
- `标识、标志、偏移`：IP 分片相关，IPv6 已禁止在路由器上对分组分片。
- `寿命`：TTL（Time-To-Live），数据包每经过一个路由器 TTL 减一，当 TTL 字段为 0，该数据包必须丢弃。
- `协议`：指定了数据包的数据部分应该交有传输层的哪个协议（TCP/UDP）。
- `首部校验和`：校验数据包是否存在错误。
- `源和目的 IP 地址`：源主机地址和目标主机地址。
- `选项`：选项字段允许 IP 首部被扩展。

#### 数据包分片

不用的链路层协议可能承载的分组长度不一定相同，一个链路层帧能承载的最大数据量叫做最大传送单元（Maximum Transmission Unit,MTU）。为了服务不同协议，网络层将数据包中数据分片成多个较小数据包分片，
用单独的链路层帧封装这些较小二点 IP 数据包，然后向输出链路发送这些帧。

### 编址

在计算机通信中，为了识别通信对端，必须要有一个类似于地址的识别码进行标识，即 IP 地址。IP 地址用于 "连接到网络中的所有主机中识别出进行通信的目标地址"。在 TCP/IP 通信中所有主机或路由器必须设定自己的 IP 地址。

当前网络以 IPv4 为主，其 IP 地址由 32 位正整数来标识。TCP/IP 通信要求将这样的 IP 地址分配给每个参与通信的主机。

IP 地址在计算机内部以二进制的方式被处理，为了可读，人们将 32 位 IP 地址以每 8 位为一组，分成 4 组，每组以 "." 隔开，再将每组数转换成十进制。

IP 地址由 "网络标识（网络地址）" 和 "主机标识（主机地址）" 两部分组成。由此，可以保证再相连的网络中每台主机的 IP 地址都不会互相重叠，即 IP 地址具有唯一性。

IP 地址中网络地址和主机地址是通过子网掩码来区分的，如 255.255.255.0，即连续 24 个 1 和 8 个 连续的 0，也写作 /24。这表示 IP 地址的前 24 位是网络地址，后 8 为是主机地址。

IP 地址分为四个级别，分别是 A 类、B 类、C 类、D 类。它是根据 IP 地址中 1-4 位的对其网络标识和主机标识进行区分的。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/network/IP地址分类.png" width="600px">
</div>

- `A 类地址`：0 开头的地址，1-8 位是它的网络标识。
- `B 类地址`：10 开头的地址，1-16 位是它的网络标识。
- `C 类地址`：110 开头的地址，1-24 位是它的网络标识。
- `D 类地址`：1110 开头的地址，1-32 位是它的网络标识。

#### 子网掩码

刚刚说过，IP 地址中网络地址和主机地址是通过子网掩码来区分的，如 C 类地址的子网掩码是 255.255.255.0，即连续 24 个 1 和 8 个 连续的 0，也写作 /24。这表示 IP 地址的前 24 位是网络地址，后 8 为是主机地址。

子网掩码只有一个作用：将某个 IP 地址划分成网络地址和主机地址两部分。通俗的话，就是用来分割子网和区分那些ip是同一个网段的，那些不是同一网段的

#### CIDR 和 VLSM

CIDR 意为 "无类型域间路由"，采用任意长度分割 IP 地址的网络标识和主机标识，不受 IP 地址分类的限制自由分配。

VLSM 意味可变长子网掩码，可以自定义子网掩码长度的机制。

如将一个 C 类地址的网络标识扩展成多个不同网络标识的网络（/24，/25，/26 等），每个网络标识下可以容纳不同数量的主机，这也就扩展了一个网络可以容纳的主机数量。

#### IPv6

IPv6 是一种为了从根本上解决 IPv4 地址耗尽的标准化网际协议。IPv4 的地址长度为 32 比特，而 IPv6 地址长度是原来的 4 倍，即 128 比特，一般写成 8 个 16 位字节。

### 路由选择

主机通常直接与一台路由器相连，该路由器是该主机的默认路由器，又称该主机的第一跳路由器。每当主机发送一个分组，该分组被传送给他的默认路由器，我们把源主机的默认路由器称为源路由器，
目的主机的默认路由器称为目的路由器。一个分组从源主机到目的主机的路由选择问题可归根为从源路由器到目的路由器的路由选择问题，实现这一行为的方式称为`路由选择算法`。

#### 静态路由和动态路由

路由器根据路由表转发数据包，它根据接收到的数据包的目标主机的 IP 地址和路由表比较的结构得出下一个应该接收的路由器。

静态路由是事先在路由器和主机中设置并将路由固定的一种方法，而动态路由是指让路由协议在运行过程中自动设计路由控制信息的一种方法。

静态路由需要手工设置，不仅繁琐，而且当某个路由器发送故障，基本上无法自动绕过故障节点。

使用动态路由，需要设置好路由协议，如 RIP。使用动态路由协议，路由器会给相邻路由器发送字节已知的网络连接信息，而这些信息又像接力一样依次传递给其他路由器，直到整个网络都了解时，路由表制作完成。

#### 路由选择算法

路由选择算法最具代表性的有两种：距离向量算法(DV)和链路状态算法(LS)。

- 距离向量算法

距离向量算法是根据距离（代价）和方向决定目标主机位置的方法。路由器之间可以互换目标网络二点方向及其距离的相关信息，并以这些信息为基础制作路由表。
这种方法处理上比较简单，不过由于只有距离和方向信息，对于复杂的网络构造，需要消耗一定时间获取稳定的路由信息。

- 链路状态算法

链路状态算法是在路由器了解网络整体连接状态的基础上生产路由表的方法，在这种方法中，每个路由器必须保持同样的信息才能进行正确的路由选择。

路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。互联网可以划分为许多较小的自治系统 AS，一个 AS 可以使用一种和别的 AS 不同的路由选择协议。
由此，可以把路由选择协议划分为两大类：

- 自治系统内部的路由选择：RIP 和 OSPF
- 自治系统间的路由选择：BGP

##### RIP
RIP（内部网关协议）是一种基于距离向量的路由选择协议。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。

RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

RIP 协议实现简单，开销小。但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器。

##### OSPF

OSPF（开放最短路径优先）是为了克服 RIP 的缺点而开发出来的。

开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了 Dijkstra 提出的最短路径算法 SPF。

OSPF 具有以下特点：

- 向本自治系统中的所有路由器发送信息，这种方法是洪泛法。
- 发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
- 只有当链路状态发生变化时，路由器才会发送信息。

所有路由器都具有全网的拓扑结构图，并且是一致的。相比于 RIP，OSPF 的更新过程收敛的很快。

##### BGP

AS 之间的路由选择很困难，主要是由于：

- 互联网规模很大；
- 各个 AS 内部使用不同的路由选择协议，无法准确定义路径的度量；
- AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。

BGP（Border Gateway Protocol，边界网关协议）是连接不同自治系统的一种协议（如 ISP），BGP 只能寻找一条比较好的路由，而不是最佳路由。
每个 AS 都必须配置 BGP 发言人，通过在两个相邻 BGP 发言人之间建立 TCP 连接来交换路由信息。
