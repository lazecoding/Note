# 系统架构

Elasticsearch 是一个基于 Lucene 库分布式、可扩展的搜索引擎，提供近实时的搜索和分析功能。

### 基础概念

在学习 Elasticsearch 架构之前了解一些术语：
- Index：这是一个逻辑概念，在实际使用中我们往往将它与数据库中 Table 对应。
- Type：这个属性在 7.x 暂留，8.x 将移除。在此前的版本一个 Index 下支持多个 Type。
- Document：Document 意为文档，相当于数据库的一行记录。
- Field：相当于数据量的 Column。
- Mapping ：相当于数据库中的 Schema，用来约束字段的类型，不过 Elasticsearch 的 mapping 可以自动根据数据创建。
- Node：节点，集群中的一个 Elasticearch 实例。
- Cluster：集群，一组拥有共同 cluster name 的节点。
- Shard：分片是集群数据的子集，索引可以切分成多个分片分布到不同节点上。
- Replica：副本是数据的备份，一个主分片往往存在多个副本分片。

### 系统架构

Elasticsearch 是一个典型的分布式系统。

#### 分布式系统

一个 Elasticsearch 集群内包含多个节点，每个节点都是一个 Elasticsearch 实例。在众多的节点中，其中会有一个 Master Node，它主要负责维护索引元数据、负责切换主分片和副本分片身份等工作，如果主节点挂了，会选举出一个新的主节点。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/es/Elasticsearch集群中的节点.png" width="600px">
</div>

为了支持对海量数据的存储和查询，Elasticsearch 引入分片的概念，一个索引被分成多个分片，每个分片都是一个功能齐全的 Lucene 实例。每个分片都由一个 Primary shard 和任意多个 Replica shard 组成，如果 Primary shard 挂了，就会从 Replica shard 中选举出一个新的 Leader 作为 Primary shard。shard 也是 Elasticsearch 实现水平扩展的方式，在数据写入时候会将索引切分到不同分片上。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/es/Elasticsearch集群中的分片.png" width="600px">
</div>

#### 平衡负载

在一个单节点、单分片的集群中，所有数据都保存在一个节点，如果这个节点挂了，分片也没有意义。而且所有的负载都在单个节点上，网络、IO、CPU、内存都可能承受过大的压力。

搜索性能取决于最慢节点的响应时间，因此最好平衡所有节点的负载。

在三个节点、两个分片、两个副本的集群，两个分片各自通过分配两个副本，最终总共得到六个碎片，它们在三个节点之间平均分配。我们不仅平衡了负载，还增加了可用性，即使突然丢失了两个节点，仍然拥有所有数据。

<div align="left">
    <img src="https://github.com/lazecoding/Note/blob/main/images/es/三节点两分配两副本的集群.png" width="600px">
</div>
