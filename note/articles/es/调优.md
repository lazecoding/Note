# 调优.md

Elasticsearch 性能调优，分层说明。

### 集群层

#### 集群规划

部署集群时，应该根据具体业务来评估初始集群大小，这些信息包括但不限于：
- 数据总量，每天的增量；
- 查询类型和搜索并发，QPS。

另一方面，需要控制最大集群规模和数据总量：
- 节点总数不应该太多：一般来说，最大集群规模最好控制在 100 个节点左右。经测试，在上千个节点的集群规模下，节点间的连接数和通信量倍增，主节点管理压力比较大。
- 单个分片不要超过 50 GB：最大集群分片总数控制在几十万的级别。太多分片同样增加了主节点的管理负担，而且集群重启恢复时间会很长。

建议为集群配置较好的硬件，搜索和分析对 CPU、内存、磁盘的性能要求都很高。

#### 独立部署主节点

将主节点和数据节点分离部署的好处是主备切换可以迅速完成。因为独立部署的主节点没有存储数据，旧的主节点离线不会产生未分配状态的分片，避免分片重新分配，新的主节点被选出后集群状态可以迅速变为 Green。

### 节点层

#### 适当的节点角色

为不同的节点赋予适当的角色，比如主节点和数据节点分类，部署单独的节点作为协调节点等。

#### 节点大小

Elasticsearch 不建议为 JVM 配置超过 32GB 的内存，当 JVM 堆内存超过 32GB 时，Java 内存指针压缩失效，浪费内存，降低 CPU 性能，GC 压力也较大。因此推荐设置为 31GB，并确保堆内存最小值（Xms）与最大值（Xmx）大小相同，防止程序在运行时动态改变堆内存大小，这是个比较消耗系统资源的过程。

#### 内存分配

搜索操作很依赖对系统 Cache 的命中，建议把 50% 的可用内存作为 Elasticsearch 的堆内存，为 Lucene 保留剩下的 50% 可用内存，用作系统 Cache。

#### 控制线程池队列大小

不要为 bulk 和 search 分配过大的队列，队列并非越大越好，队列缓存的数据越多，GC 压力越大，默认的队列大小基本够用了，即使在压力测试的场景中，默认队列大小也足以支持。

### 线程池线程数

Elasticsearch 默认的线程设置已经是很合理的了。对于所有的线程池，线程个数是根据 CPU 核心数设置的。处理器的计算能力是有限的，一个处理器同时只能运行一个线程，拥有更多的线程会导致你的处理器频繁切换线程上下文。当处理器需要切换到其它不同的线程的时候，它会存储当前的状态（寄存器等等），然后加载另外一个线程。如果幸运的话，这个切换发生在同一个核心，如果不幸的话，这个切换可能发生在不同的核心，这就需要在内核间总线上进行传输。

所以请不要调整线程池的线程数。如果你真想调整，一定要关注你的 CPU 核心数，最多设置成核心数的两倍，再多了可能就是浪费。


<!-- #### GC -->

### 系统层

#### 禁止交换分区

操作系统为了缓解内存不足对应用程序的影响，允许把一部分内存中的数据换到磁盘上，以达到应用程序对内存使用的缓冲，这些内存数据被换到磁盘上的区域，就是 Swap。

一般在安装操作系统的时候直接关闭交换分区。也可以在配置文件中对内存进行锁定，以避免交换内存。

````C
bootstrap.mlockall: true
````

