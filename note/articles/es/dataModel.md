# ElasticSearch 数据模型

Elasticsearch 是一个去中心化的分布式搜索引擎。一个 Elasticsearch 集群由多个节点组成，每个节点都是一个 Elasticsearch 实例。Elasticsearch 将数据以分片的形式将数据分不到不同节点上，每个数据分片由一组数据副本组成，这组副本由一个主副本和多个从副本组成。

### Master 节点

一个 Elasticsearch 集群内包含多个节点，每个节点都是一个 Elasticsearch 实例。在众多的节点中，其中会有一个 Master Node，它主要负责维护索引元数据、负责切换主分片和副本分片身份等工作。如果 Master 节点挂了，会选举出一个新的 Master 节点。

### 基本写入模型

当一个节点接收到写入操作，这个节点将作为`协调节点`，它会通过解析 routing 参数来确定副本组，之后转发该操作到相关副本组所在的节点。

当主分片接收到操作请求，会对操作进行验证并本地执行。操作成功执行后，主分片并行转发该操作到副本分片，一旦所有副本分片成功执行操作并恢复主分片，主分片会把请求执行成功的信息返回给协调节点，由协调节点返回给客户端。

### 写故障处理

写入期间可能会发生错误或异常导致操作无法执行成功。

对于主分片自身的错误，它所在的节点会发送一个消息到 Master 节点。这个操作会等待 Master 节点提升一个副本分片为主分片，再将这个操作转发给新的主分片。

主分片操作成功后，主分片还需要处理副本分片潜在发生的错误。如果是副本分片的错误，主分片会发送一条信息到 Master 节点，要求 Master 节点移除有问题的副本分片。此外，Master 会在移除问题副本分片后，指导另一个节点建立一个新的分片副本，以便让系统恢复成健康的状态。

主分片在转发请求到副分片时，主分片也可能会由于网络分区等原因被隔离。副分片会拒绝旧的主分片的操作请求，当旧的主分片接收到来自副本分片的拒绝请求的响应，它会访问 Master 节点获取分片状态，最后将请求路由到新的主分片上。

### 基本读取模型

当一个节点接收到读取操作，这个节点将作为`协调节点`，它会通过解析 routing 参数来确定相关副本组，之后转发该操作到相关副本组所在的节点。

大多数读请求涉及一个或多个索引，通常需要从多个分片中读取。节点会从相关副本组中选取相关分片的一个活跃副本获取数据并返回给协调节点，它可以是主分片或副本分片。

协调节点会将来自一个或多个节点的响应结果进行合并并返回给客户端。

### 读故障处理

当分片不能相应一个读请求时,协调节点会从副本组中选择另一个副本,将请求转发给它.没有可用的分片副本会导致重复的错误.在某些情况下，ElasticSearch 倾向于尽早响应,即便是只有部分结果,也不等待问题被解决。